<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.esm.js"></script>
    <script nomodule src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/@ionic/core/css/ionic.bundle.css" rel="stylesheet">
</head>

<body>
    <ion-app>
        <ion-header>
            <ion-toolbar>
                <ion-title>Testové otázky</ion-title>
            </ion-toolbar>
        </ion-header>

        <ion-content class="ion-padding">
            <div id="quiz-container"></div>

            <ion-button expand="block" onclick="submitAnswers()">Odoslať odpovede</ion-button>

            <ion-card id="result-card" style="display:none; margin-top:20px;">
                <ion-card-header>
                    <ion-card-title>Výsledok</ion-card-title>
                </ion-card-header>
                <ion-card-content id="result-content">
                </ion-card-content>
            </ion-card>
        </ion-content>
    </ion-app>

    <script>
        let questions = [];

        fetch('questions.xml')
            .then(response => response.text())
            .then(data => {
                const parser = new DOMParser();
                const xml = parser.parseFromString(data, "application/xml");
                const questionNodes = xml.querySelectorAll('question');
                questions = [];

                questionNodes.forEach((qNode, index) => {
                    const text = qNode.querySelector('text').textContent;
                    const options = qNode.querySelectorAll('option');
                    const answer = qNode.querySelector('answer').textContent.split(',').map(x => x.trim());

                    const q = {
                        id: index,
                        text: text,
                        options: Array.from(options).map(opt => ({
                            id: opt.getAttribute('id'),
                            text: opt.textContent
                        })),
                        correct: answer
                    };

                    questions.push(q);
                });

                displayQuestions();
            });

        function displayQuestions() {
            const container = document.getElementById('quiz-container');
            container.innerHTML = '';

            questions.forEach((q, index) => {
                const card = document.createElement('ion-card');
                card.id = `qcard${index}`; // pridáme ID pre farbenie
                card.innerHTML = `
          <ion-card-header>
            <ion-card-title>Otázka ${index + 1}</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <p>${q.text}</p>
            ${q.options.map(opt => `
              <ion-item>
                <ion-checkbox slot="start" value="${opt.id}" name="q${index}"></ion-checkbox>
                <ion-label>${opt.id}) ${opt.text}</ion-label>
              </ion-item>
            `).join('')}
          </ion-card-content>
        `;
                container.appendChild(card);
            });
        }

        function submitAnswers() {
            let totalScore = 0; // súčet bodov
            const maxScore = questions.length; // maximálny počet bodov (každá otázka má 1 bod)

            questions.forEach((q, index) => {
                const checkboxes = document.querySelectorAll(`ion-checkbox[name="q${index}"]`);
                const selected = Array.from(checkboxes)
                    .filter(cb => cb.checked || cb.getAttribute('aria-checked') === 'true')
                    .map(cb => cb.value);

                const selectedSet = new Set(selected);
                const correctSet = new Set(q.correct);

                const card = document.querySelector(`#qcard${index}`);
                const cardContent = card.querySelector('ion-card-content');

                let correctSelected = selected.filter(x => correctSet.has(x)).length; // počet správnych zaškrtnutých
                let wrongSelected = selected.filter(x => !correctSet.has(x)).length; // počet zle zaškrtnutých
                const totalCorrect = correctSet.size; // počet všetkých správnych odpovedí

                let score = Math.max(0, (correctSelected - wrongSelected) / totalCorrect); // vypočíta bod za otázku
                if (score >= 1) {
                    score = 1; // ak všetko správne a nič navyše
                    card.style.backgroundColor = '#d4edda'; // zelená
                    cardContent.innerHTML += `<ion-text color="success"><p><b>✔️ Správne!</b> (${q.correct.join(', ')})</p></ion-text>`;
                } else if (score > 0) {
                    card.style.backgroundColor = '#ffeeba'; // oranžová
                    cardContent.innerHTML += `<ion-text color="warning"><p><b>⚠️ Čiastočne správne!</b> (${q.correct.join(', ')})</p></ion-text>`;
                } else {
                    card.style.backgroundColor = '#f8d7da'; // červená
                    cardContent.innerHTML += `<ion-text color="danger"><p><b>❌ Nesprávne!</b> Správne odpovede: ${q.correct.join(', ')}</p></ion-text>`;
                }

                totalScore += score;
            });

            const percent = ((totalScore / maxScore) * 100).toFixed(2);
            const resultCard = document.getElementById('result-card');
            const resultContent = document.getElementById('result-content');

            resultContent.innerHTML = `
    <h2>Výsledok: ${percent}% (${totalScore.toFixed(2)} bodov z ${maxScore})</h2>
  `;
            resultCard.style.display = 'block';
        }



        function setsAreEqual(a, b) {
            if (a.size !== b.size) return false;
            for (const item of a) {
                if (!b.has(item)) return false;
            }
            return true;
        }
    </script>
</body>

</html>